name: Deploy to Vercel

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      CI: "true"  # å¼ºåˆ¶éäº¤äº’æ¨¡å¼ï¼Œè·³è¿‡æ‰€æœ‰æé—®
      VERCEL_FORCE: "true"  # å¼ºåˆ¶è¦†ç›–é…ç½®

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´ Git å†å²ï¼Œé¿å… git log é”™è¯¯

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # æ‚¨çš„é¡¹ç›® Python ç‰ˆæœ¬

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # æ‚¨çš„ requirements.txt

      - name: Install Latest Vercel CLI (Silent)
        run: |
          npm install -g vercel@latest --silent  # é™é»˜å®‰è£…æœ€æ–°ç‰ˆï¼ˆv34+ï¼‰ï¼Œå‡å°‘ npm è­¦å‘Š
          vercel --version  # éªŒè¯ç‰ˆæœ¬ï¼ˆè¾“å‡ºå¦‚ v34.2.3ï¼‰

      - name: Deploy to Vercel (Non-Interactive)
        run: |
          # è‡ªåŠ¨é“¾æ¥/åˆ›å»ºé¡¹ç›®ï¼ˆè·³è¿‡äº¤äº’ï¼‰
          vercel link --yes --prod --force || true
          
          # å¼ºåˆ¶éƒ¨ç½²ï¼Œæ°¸ä¸æé—®
          vercel --prod --yes --force --confirm --skip-build || true
          
          # æå–å¹¶è¾“å‡ºéƒ¨ç½² URL
          DEPLOY_URL=$(vercel ls --yes | grep -o 'https://[^ ]*\.vercel\.app' | head -1)
          if [ -n "$DEPLOY_URL" ]; then
            echo "ğŸš€ éƒ¨ç½²æˆåŠŸï¼è®¿é—®ï¼š$DEPLOY_URL"
          else
            echo "ğŸ“Š éƒ¨ç½²å®Œæˆï¼Œè¯·è®¿é—® Vercel Dashboard æŸ¥çœ‹ URL"
          fi
