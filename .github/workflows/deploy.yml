name: Deploy to Vercel

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      CI: "true"  # 强制非交互模式，跳过所有提问
      VERCEL_FORCE: "true"  # 强制覆盖配置

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 完整 Git 历史，避免 git log 错误

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # 您的项目 Python 版本

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # 您的 requirements.txt

      - name: Install Latest Vercel CLI (Silent)
        run: |
          npm install -g vercel@latest --silent  # 静默安装最新版（v34+），减少 npm 警告
          vercel --version  # 验证版本（输出如 v34.2.3）

      - name: Deploy to Vercel (Non-Interactive)
        run: |
          # 自动链接/创建项目（跳过交互）
          vercel link --yes --prod --force || true
          
          # 强制部署，永不提问
          vercel --prod --yes --force --confirm --skip-build || true
          
          # 提取并输出部署 URL
          DEPLOY_URL=$(vercel ls --yes | grep -o 'https://[^ ]*\.vercel\.app' | head -1)
          if [ -n "$DEPLOY_URL" ]; then
            echo "🚀 部署成功！访问：$DEPLOY_URL"
          else
            echo "📊 部署完成，请访问 Vercel Dashboard 查看 URL"
          fi
